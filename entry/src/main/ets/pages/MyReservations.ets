import { router } from '@kit.ArkUI';
import promptAction from '@ohos.promptAction';
import DBTools from '../utils/DBTools';
import Reservation from '../model/Reservation';

@CustomDialog
struct RatingDialog {
  controller: CustomDialogController
  facilityName: string = ''
  onConfirm: (score: number, comment: string) => void = () => {}
  @State score: number = 5
  @State comment: string = ''

  build() {
    Column() {
      Text(`è¯„ä»·: ${this.facilityName}`)
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .margin({ bottom: 20 })

      Row() {
        Text('è¯„åˆ†: ' + this.score.toFixed(0))
          .fontSize(16)
          .margin({ right: 10 })
        Slider({
          value: this.score,
          min: 1,
          max: 5,
          step: 1,
          style: SliderStyle.OutSet
        })
        .onChange((value: number) => {
          this.score = value
        })
        .layoutWeight(1)
      }.width('100%').margin({ bottom: 20 })

      TextArea({ placeholder: 'è¯·è¾“å…¥æ‚¨çš„è¯„ä»·...', text: this.comment })
        .height(100)
        .onChange((value) => {
          this.comment = value
        })
        .margin({ bottom: 20 })

      Row() {
        Button('å–æ¶ˆ')
          .onClick(() => {
            this.controller.close()
          })
          .backgroundColor(Color.Gray)
          .margin({ right: 20 })
        
        Button('æäº¤')
          .onClick(() => {
            this.onConfirm(this.score, this.comment)
            this.controller.close()
          })
      }
      .justifyContent(FlexAlign.Center)
    }
    .padding(20)
    .backgroundColor(Color.White)
    .borderRadius(10)
    .width('90%')
  }
}

@Entry
@Component
struct MyReservations {
  @State reservations: Array<Reservation> = [];
  @State isLoading: boolean = true;
  
  dialogController: CustomDialogController | null = null;

  aboutToAppear() {
    this.loadReservations();
  }

  loadReservations() {
    const userId = AppStorage.get<number>('currentUserId');
    if (!userId) {
      return;
    }

    DBTools.queryReservationsByUserId(userId).then((data) => {
      this.reservations = data;
      this.isLoading = false;
    }).catch((err: Error) => {
      console.error('Failed to load reservations:', err.message);
      this.isLoading = false;
    });
  }

  formatDate(timestamp: number): string {
    const date = new Date(timestamp);
    return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
  }

  getDisplayStatus(item: Reservation): string {
    if (item.status === 'cancelled') {
      return 'å·²å–æ¶ˆ';
    }
    const now = new Date().getTime();
    if (now < item.start_time) {
      return 'å·²é¢„çº¦';
    } else if (now >= item.start_time && now <= item.end_time) {
      return 'è¿›è¡Œä¸­';
    } else {
      return 'å·²å®Œæˆ';
    }
  }

  getStatusColor(status: string): string {
    switch (status) {
      case 'å·²é¢„çº¦': return '#FAAD14'; // Orange
      case 'è¿›è¡Œä¸­': return '#1890FF'; // Blue
      case 'å·²å®Œæˆ': return '#52C41A'; // Green
      case 'å·²å–æ¶ˆ': return '#FF4D4F'; // Red
      default: return '#999999';
    }
  }

  openRatingDialog(item: Reservation) {
    this.dialogController = new CustomDialogController({
      builder: RatingDialog({
        facilityName: item.facility_name || 'è®¾æ–½',
        onConfirm: (score, comment) => {
          this.submitRating(item, score, comment)
        }
      }),
      autoCancel: true,
      customStyle: true // ä½¿ç”¨è‡ªå®šä¹‰æ ·å¼ï¼Œé¿å…é»˜è®¤è¾¹è·é—®é¢˜
    })
    this.dialogController.open()
  }

  submitRating(item: Reservation, score: number, comment: string) {
    const userId = AppStorage.get<number>('currentUserId');
    if (!userId) return;

    DBTools.insertOrUpdateRating(userId, item.facility_id, score, comment).then(() => {
      promptAction.showToast({ message: 'è¯„ä»·æäº¤æˆåŠŸ' })
    }).catch((err: Error) => {
      promptAction.showToast({ message: 'è¯„ä»·å¤±è´¥: ' + err.message })
    })
  }

  handleItemClick(item: Reservation) {
    const status = this.getDisplayStatus(item);
    
    if (status === 'å·²å–æ¶ˆ') {
      return;
    }
    
    if (status === 'å·²é¢„çº¦') {
      promptAction.showDialog({
        title: 'å–æ¶ˆé¢„çº¦',
        message: 'ç¡®å®šè¦å–æ¶ˆè¯¥é¢„çº¦å—ï¼Ÿ',
        buttons: [
          { text: 'æš‚ä¸å–æ¶ˆ', color: '#000000' },
          { text: 'ç¡®è®¤å–æ¶ˆ', color: '#FF0000' }
        ]
      }).then((result) => {
        if (result.index === 1) {
          DBTools.cancelReservation(item.reservation_id).then(() => {
            promptAction.showToast({ message: 'é¢„çº¦å·²å–æ¶ˆ' });
            this.loadReservations();
          })
        }
      })
    } else if (status === 'è¿›è¡Œä¸­') {
      promptAction.showDialog({
        title: 'æå‰ç»“æŸ',
        message: 'ç¡®å®šè¦æå‰ç»“æŸä½¿ç”¨å—ï¼Ÿç»“æŸæ—¶é—´å°†æ›´æ–°ä¸ºå½“å‰æ—¶é—´ã€‚',
        buttons: [
          { text: 'å–æ¶ˆ', color: '#000000' },
          { text: 'ç¡®è®¤ç»“æŸ', color: '#1890FF' }
        ]
      }).then((result) => {
        if (result.index === 1) {
          const now = new Date().getTime();
          DBTools.finishReservationEarly(item.reservation_id, now).then(() => {
            promptAction.showToast({ message: 'å·²æå‰ç»“æŸ' });
            this.loadReservations();
          })
        }
      })
    } else if (status === 'å·²å®Œæˆ') {
      this.openRatingDialog(item);
    }
  }

  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text('ğŸ”™')
          .fontSize(20)
          .margin({ right: 5 })
          .onClick(() => {
            router.back();
          })
        Text('æˆ‘çš„é¢„çº¦')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .margin({ left: 10 })
      }
      .width('100%')
      .padding(15)
      .backgroundColor(Color.White)
      .shadow({ radius: 2, color: '#1F000000', offsetY: 1 })

      if (this.isLoading) {
        LoadingProgress().width(50).height(50).margin({ top: 50 })
      } else if (this.reservations.length === 0) {
        Column() {
          Text('ğŸ“­')
            .fontSize(50)
            .margin({ bottom: 10 })
          Text('æš‚æ— é¢„çº¦è®°å½•')
            .fontSize(16)
            .fontColor(Color.Gray)
        }
        .width('100%')
        .margin({ top: 100 })
        .alignItems(HorizontalAlign.Center)
      } else {
        List({ space: 10 }) {
          ForEach(this.reservations, (item: Reservation) => {
            ListItem() {
              Column() {
                Row() {
                  Text('ğŸŸï¸ ' + (item.facility_name || 'æœªçŸ¥è®¾æ–½'))
                    .fontSize(18)
                    .fontWeight(FontWeight.Bold)
                  Blank()
                  Text(this.getDisplayStatus(item))
                    .fontColor(Color.White)
                    .fontSize(12)
                    .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                    .backgroundColor(this.getStatusColor(this.getDisplayStatus(item)))
                    .borderRadius(10)
                }
                .width('100%')
                .margin({ bottom: 12 })

                Row() {
                  Text('ğŸ•’ å¼€å§‹ï¼š')
                    .fontSize(14)
                    .fontColor(Color.Gray)
                  Text(this.formatDate(item.start_time))
                    .fontSize(14)
                }
                .width('100%')
                .margin({ bottom: 4 })

                Row() {
                  Text('ğŸ•’ ç»“æŸï¼š')
                    .fontSize(14)
                    .fontColor(Color.Gray)
                  Text(this.formatDate(item.end_time))
                    .fontSize(14)
                }
                .width('100%')
              }
              .width('100%')
              .padding(16)
              .backgroundColor(Color.White)
              .borderRadius(10)
              .shadow({ radius: 2, color: '#1F000000', offsetY: 1 })
              .onClick(() => {
                this.handleItemClick(item);
              })
            }
          })
        }
        .width('100%')
        .layoutWeight(1)
        .padding(16)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F7FA')
  }
}
