import { router } from '@kit.ArkUI';
import relationalStore from '@ohos.data.relationalStore';
import promptAction from '@ohos.promptAction';
import DBTools from '../utils/DBTools';
import Facility from '../model/Facility'; // å¯¼å…¥ Facility æ¨¡å‹
import Reservation from '../model/Reservation';
import FacilityRating from '../model/FacilityRating';
import Activity from '../model/Activity';

@Entry
@Component
export struct FacilityDetail {
  @State facility: Facility | null = null;
  @State startTime: Date = new Date();
  @State endTime: Date = new Date(new Date().getTime() + 60 * 60 * 1000); // é»˜è®¤ç»“æŸæ—¶é—´ä¸ºå½“å‰æ—¶é—´åä¸€å°æ—¶
  @State myReservations: Array<Reservation> = [];
  @State ratings: Array<FacilityRating> = [];
  @State activities: Array<Activity> = [];

  // é¡µé¢åŠ è½½æ—¶è·å–ä¼ é€’çš„å‚æ•°
  aboutToAppear() {
    const params = router.getParams() as Record<string, Object>;
    if (params && params['facility']) {
      this.facility = params['facility'] as Facility;
      this.loadMyReservations();
      this.loadRatings();
      this.loadActivities();
    }
  }

  onPageShow() {
    if (this.facility) {
      this.loadMyReservations();
      this.loadRatings();
      this.loadActivities();
    }
  }

  loadMyReservations() {
    const userId = AppStorage.get<number>('currentUserId');
    if (userId && this.facility && this.facility.facility_id) {
      DBTools.queryReservationsByUserAndFacility(userId, this.facility.facility_id).then((data) => {
        this.myReservations = data;
      });
    }
  }

  loadRatings() {
    if (this.facility && this.facility.facility_id) {
      DBTools.queryRatingsByFacilityId(this.facility.facility_id).then((data) => {
        this.ratings = data;
      });
    }
  }

  loadActivities() {
    if (this.facility && this.facility.facility_id) {
      DBTools.queryActivitiesByFacilityId(this.facility.facility_id).then((data) => {
        this.activities = data;
      });
    }
  }

  handleJoinActivity(activity: Activity) {
    const userId = AppStorage.get<number>('currentUserId');
    if (!userId) {
      this.showToast('è¯·å…ˆç™»å½•');
      return;
    }
    
    DBTools.checkActivityParticipation(activity.activity_id, userId).then((isJoined) => {
      if (isJoined) {
        this.showToast('æ‚¨å·²æŠ¥åå‚åŠ è¯¥æ´»åŠ¨');
        return;
      }
      
      DBTools.joinActivity(activity.activity_id, userId).then((rowId) => {
        if (rowId > 0) {
          this.showToast('æŠ¥åæˆåŠŸ');
        } else {
          this.showToast('æŠ¥åå¤±è´¥');
        }
      });
    });
  }

  getReservationStatus(item: Reservation): string {
    if (item.status === 'cancelled') {
      return 'å·²å–æ¶ˆ';
    }
    const startTime = item.start_time;
    const endTime = item.end_time;
    const now = new Date().getTime();
    if (now < startTime) {
      return 'å·²é¢„çº¦';
    } else if (now >= startTime && now <= endTime) {
      return 'è¿›è¡Œä¸­';
    } else {
      return 'å·²å®Œæˆ';
    }
  }

  getStatusColor(status: string): string {
    switch (status) {
      case 'å·²é¢„çº¦': return '#FAAD14'; // Orange
      case 'è¿›è¡Œä¸­': return '#1890FF'; // Blue
      case 'å·²å®Œæˆ': return '#52C41A'; // Green
      case 'å·²å–æ¶ˆ': return '#FF4D4F'; // Red
      default: return '#999999';
    }
  }

  handleReservation() {
    if (!this.facility || !this.facility.facility_id) return;

    // ä¿®æ”¹ï¼šä» AppStorage è·å–å…¨å±€å­˜å‚¨çš„ç”¨æˆ·ID
    const userId = AppStorage.get<number>('currentUserId'); 
    if (userId === undefined) {
      this.showToast('ç”¨æˆ·æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•');
      return;
    }

    const startTime = this.startTime.getTime();
    const endTime = this.endTime.getTime();

    if (startTime >= endTime) {
      this.showToast('ç»“æŸæ—¶é—´å¿…é¡»æ™šäºå¼€å§‹æ—¶é—´');
      return;
    }
    // æ£€æŸ¥å†²çª
    DBTools.checkReservationConflict(this.facility!.facility_id, startTime, endTime).then((isConflict: boolean) => {
      if (isConflict) {
        this.showToast('è¯¥æ—¶é—´æ®µå·²è¢«é¢„çº¦ï¼Œè¯·é€‰æ‹©å…¶ä»–æ—¶é—´');
        return;
      }
      // æ„å»ºé¢„çº¦æ•°æ®
      // æ³¨æ„ï¼šSQLite/RdbStore é€šå¸¸å­˜å‚¨æ—¶é—´æˆ³æˆ–å­—ç¬¦ä¸²ï¼Œè¿™é‡Œå­˜æ—¶é—´æˆ³
      const reservation: relationalStore.ValuesBucket = {
        'user_id': userId,
        'facility_id': this.facility!.facility_id,
        'start_time': startTime, // å­˜æ—¶é—´æˆ³
        'end_time': endTime,     // å­˜æ—¶é—´æˆ³
        'status': 'pending'
      };
      DBTools.insertReservation(reservation).then((rowId: number) => {
        if (rowId > 0) {
          promptAction.showToast({
            message: 'é¢„çº¦æˆåŠŸï¼Œé¢„çº¦ID: ' + rowId,
            duration: 3000
          });
          this.loadMyReservations(); // åˆ·æ–°é¢„çº¦åˆ—è¡¨
          // router.back(); // ä¿æŒåœ¨å½“å‰é¡µé¢ï¼Œæ–¹ä¾¿æŸ¥çœ‹é¢„çº¦è®°å½•
        } else {
          this.showToast('é¢„çº¦å¤±è´¥');
        }
      }).catch((err: Error) => {
        this.showToast('é¢„çº¦å‡ºé”™: ' + err.message);
      });
    }).catch((err: Error) => {
      this.showToast('æ£€æŸ¥å†²çªå‡ºé”™: ' + err.message);
    });
  }

  showToast(message: string) {
    promptAction.showToast({ message: message });
  }

  // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
  formatDate(date: Date): string {
    return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
  }

  // é€‰æ‹©æ—¥æœŸå’Œæ—¶é—´
  selectDateTime(isStart: boolean) {
    DatePickerDialog.show({
      start: new Date(),
      end: new Date("2030-12-31"),
      selected: isStart ? this.startTime : this.endTime,
      onAccept: (value: DatePickerResult) => {
        TimePickerDialog.show({
          selected: isStart ? this.startTime : this.endTime,
          useMilitaryTime: true,
          onAccept: (timeValue: TimePickerResult) => {
            const newDate = new Date(value.year!, value.month!, value.day!, timeValue.hour, timeValue.minute);
            if (isStart) {
              this.startTime = newDate;
            } else {
              this.endTime = newDate;
            }
          }
        })
      }
    })
  }

  build() {
    Column() {
      // 1. é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Text('ğŸ”™')
          .fontSize(20)
          .margin({ right: 5 })
          .onClick(() => {
            router.back();
          })
        Text('è®¾æ–½è¯¦æƒ…')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .margin({ left: 10 })
      }
      .width('100%')
      .padding(15)
      .backgroundColor(Color.White)
      .shadow({ radius: 2, color: '#1F000000', offsetY: 1 })

      if (this.facility) {
        Column() {
          Scroll() {
            Column() {
              // 2. è®¾æ–½ä¿¡æ¯å±•ç¤º
              Column() {
                Text(this.facility.facility_name || 'æœªçŸ¥è®¾æ–½')
                  .fontSize(24)
                  .fontWeight(FontWeight.Bold)
                  .margin({ bottom: 10 })
                
                Row() {
                  Text(this.facility.facility_type)
                    .fontSize(12)
                    .fontColor(Color.White)
                    .backgroundColor('#1698CE')
                    .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                    .borderRadius(4)
                  
                  Row() {
                    Text('ğŸ“')
                      .fontSize(14)
                      .margin({ right: 4 })
                    Text(this.facility.location)
                      .fontSize(14)
                      .fontColor(Color.Gray)
                  }
                  .margin({ left: 10 })
                }
                .width('100%')
                .margin({ bottom: 15 })

                Text('ğŸ“ è®¾æ–½æè¿°ï¼š')
                  .fontSize(16)
                  .fontWeight(FontWeight.Bold)
                  .margin({ bottom: 5 })
                Text(this.facility.description || 'æš‚æ— æè¿°')
                  .fontSize(14)
                  .fontColor('#666')
                  .lineHeight(20)
              }
              .width('100%')
              .padding(20)
              .backgroundColor(Color.White)
              .borderRadius(10)
              .shadow({ radius: 2, color: '#1F000000', offsetY: 1 })
              .margin({ top: 15, bottom: 15 })
              .alignItems(HorizontalAlign.Start)

              // æ–°å¢ï¼šè®¾æ–½æ´»åŠ¨å±•ç¤º
              Column() {
                Row() {
                  Text('ğŸ“… çƒ­é—¨æ´»åŠ¨')
                    .fontSize(18)
                    .fontWeight(FontWeight.Bold)
                  Blank()
                  Button('+ å‘èµ·æ´»åŠ¨')
                    .fontSize(12)
                    .height(28)
                    .backgroundColor('#1698CE')
                    .onClick(() => {
                      router.pushUrl({
                        url: 'pages/ActivityCreate',
                        params: {
                          facility: this.facility
                        }
                      })
                    })
                }
                .width('100%')
                .margin({ bottom: 10 })
                
                if (this.activities.length === 0) {
                  Text('æš‚æ— æ´»åŠ¨ï¼Œå¿«æ¥å‘èµ·ç¬¬ä¸€ä¸ªæ´»åŠ¨å§ï¼')
                    .fontSize(14)
                    .fontColor(Color.Gray)
                    .margin({ top: 10, bottom: 10 })
                    .width('100%')
                    .textAlign(TextAlign.Center)
                } else {
                  List({ space: 10 }) {
                    ForEach(this.activities, (item: Activity) => {
                      ListItem() {
                        Column() {
                          Row() {
                            Text(item.title)
                              .fontSize(16)
                              .fontWeight(FontWeight.Bold)
                            Blank()
                            if (item.status === 'open') {
                                Button('æŠ¥å')
                                .fontSize(12)
                                .height(24)
                                .backgroundColor('#52C41A')
                                .onClick(() => this.handleJoinActivity(item))
                            } else {
                                Text(item.status)
                                .fontSize(12)
                                .fontColor(Color.Gray)
                            }
                          }
                          .width('100%')
                          .margin({ bottom: 5 })

                          Text(`ğŸ•’ æ—¶é—´: ${item.start_time}`)
                            .fontSize(14)
                            .fontColor(Color.Gray)
                            .margin({ bottom: 5 })
                            
                          Text(item.description)
                            .fontSize(14)
                            .fontColor('#333')
                            .maxLines(2)
                            .textOverflow({ overflow: TextOverflow.Ellipsis })
                        }
                        .width('100%')
                        .padding(10)
                        .backgroundColor('#F9F9F9')
                        .borderRadius(5)
                      }
                    })
                  }
                }
              }
              .width('100%')
              .padding(20)
              .backgroundColor(Color.White)
              .borderRadius(10)
              .shadow({ radius: 2, color: '#1F000000', offsetY: 1 })
              .margin({ bottom: 15 })

              // æ–°å¢ï¼šæˆ‘çš„é¢„çº¦è®°å½•å±•ç¤º
              if (this.myReservations.length > 0) {
                Column() {
                  Text('ğŸ“‹ æˆ‘çš„é¢„çº¦è®°å½•')
                    .fontSize(18)
                    .fontWeight(FontWeight.Bold)
                    .margin({ bottom: 10 })
                  
                  List({ space: 10 }) {
                    ForEach(this.myReservations, (item: Reservation) => {
                      ListItem() {
                        Row() {
                          Column() {
                            Text(`${this.formatDate(new Date(item.start_time))} - ${this.formatDate(new Date(item.end_time)).split(' ')[1]}`)
                              .fontSize(14)
                          }
                          Blank()
                          Text(this.getReservationStatus(item))
                            .fontSize(14)
                            .fontColor(this.getStatusColor(this.getReservationStatus(item)))
                        }
                        .width('100%')
                        .padding(10)
                        .backgroundColor('#F9F9F9')
                        .borderRadius(5)
                      }
                    })
                  }
                  .height(this.myReservations.length > 3 ? 150 : 'auto') // é™åˆ¶é«˜åº¦ï¼Œé¿å…å ç”¨è¿‡å¤šç©ºé—´
                }
                .width('100%')
                .padding(20)
                .backgroundColor(Color.White)
                .borderRadius(10)
                .shadow({ radius: 2, color: '#1F000000', offsetY: 1 })
                .margin({ bottom: 15 })
              }

              // æ–°å¢ï¼šç”¨æˆ·è¯„ä»·å±•ç¤º
              Column() {
                Text('ğŸ’¬ ç”¨æˆ·è¯„ä»·')
                  .fontSize(18)
                  .fontWeight(FontWeight.Bold)
                  .margin({ bottom: 10 })

                if (this.ratings.length === 0) {
                  Text('æš‚æ— è¯„ä»·')
                    .fontSize(14)
                    .fontColor(Color.Gray)
                    .margin({ top: 10, bottom: 10 })
                } else {
                  List({ space: 10 }) {
                    ForEach(this.ratings, (item: FacilityRating) => {
                      ListItem() {
                        Column() {
                          Row() {
                            Text(item.full_name || item.username || 'åŒ¿åç”¨æˆ·')
                              .fontSize(16)
                              .fontWeight(FontWeight.Bold)
                            Blank()
                            Text(item.score + 'åˆ†')
                              .fontSize(14)
                              .fontColor('#FAAD14')
                          }
                          .width('100%')
                          .margin({ bottom: 5 })

                          Text(item.comment || 'æ— è¯„è®ºå†…å®¹')
                            .fontSize(14)
                            .fontColor('#333')
                            .width('100%')
                        }
                        .width('100%')
                        .padding(10)
                        .backgroundColor('#F9F9F9')
                        .borderRadius(5)
                      }
                    })
                  }
                  .height(this.ratings.length > 3 ? 200 : 'auto')
                }
              }
              .width('100%')
              .padding(20)
              .backgroundColor(Color.White)
              .borderRadius(10)
              .shadow({ radius: 2, color: '#1F000000', offsetY: 1 })
              .margin({ bottom: 15 })

              // 3. é¢„çº¦æ—¶é—´é€‰æ‹©
              Column() {
                Text('â° é¢„çº¦æ—¶é—´')
                  .fontSize(18)
                  .fontWeight(FontWeight.Bold)
                  .margin({ bottom: 15 })

                Row() {
                  Text('å¼€å§‹æ—¶é—´')
                    .width(80)
                  Text(this.formatDate(this.startTime))
                    .fontSize(16)
                    .fontColor('#1698CE')
                    .layoutWeight(1)
                    .textAlign(TextAlign.End)
                    .onClick(() => this.selectDateTime(true))
                }
                .width('100%')
                .padding({ top: 10, bottom: 10 })
                .border({ width: { bottom: 1 }, color: '#EEE' })

                Row() {
                  Text('ç»“æŸæ—¶é—´')
                    .width(80)
                  Text(this.formatDate(this.endTime))
                    .fontSize(16)
                    .fontColor('#1698CE')
                    .layoutWeight(1)
                    .textAlign(TextAlign.End)
                    .onClick(() => this.selectDateTime(false))
                }
                .width('100%')
                .padding({ top: 10, bottom: 10 })
                .border({ width: { bottom: 1 }, color: '#EEE' })
              }
              .width('100%')
              .padding(20)
              .backgroundColor(Color.White)
              .borderRadius(10)
              .shadow({ radius: 2, color: '#1F000000', offsetY: 1 })
            }
            .width('100%')
            .padding({ left: 15, right: 15 })
          }
          .layoutWeight(1)
          .scrollBar(BarState.Auto)
          .align(Alignment.Top)

          // 4. åº•éƒ¨æŒ‰é’®
          Button('ç«‹å³é¢„çº¦')
            .width('90%')
            .height(50)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .backgroundColor('#1698CE')
            .shadow({ radius: 5, color: '#4F1698CE', offsetY: 3 })
            .margin({ top: 10, bottom: 20 })
            .onClick(() => {
              this.handleReservation();
            })
        }
        .width('100%')
        .height('100%')
        .layoutWeight(1)
      } else {
        // åŠ è½½ä¸­æˆ–æ— æ•°æ®çŠ¶æ€
        Column() {
          Text('æ­£åœ¨åŠ è½½è®¾æ–½ä¿¡æ¯...')
            .fontSize(16)
            .fontColor(Color.Gray)
            .margin({ top: 50 })
        }
        .width('100%')
        .alignItems(HorizontalAlign.Center)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
}