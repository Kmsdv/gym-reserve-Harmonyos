import { router } from '@kit.ArkUI';
import DBTools from '../utils/DBTools';
import Facility from '../model/Facility';
import User from '../model/User';
import Activity from '../model/Activity';

@Entry
@Component
struct Success {
  @State currentIndex: number = 0;
  @State facilities: Array<Facility> = [];
  @State currentUser: User | null = null;
  @State recommendations: Array<Facility> = [];
  @State recommendedActivities: Array<Activity> = [];
  @State recommendationTitle: string = 'ä»Šæ—¥æ¨è';

  private controller: TabsController = new TabsController();

  aboutToAppear() {
    // åŠ è½½è®¾æ–½æ•°æ®
    this.loadFacilities();
    // åŠ è½½ç”¨æˆ·ä¿¡æ¯
    this.loadUserInfo();
    // åŠ è½½æ¨è
    this.loadRecommendations();
  }

  onPageShow() {
    this.loadUserInfo();
    this.loadRecommendations();
  }

  async loadRecommendations() {
    // åŠ è½½æ´»åŠ¨æ¨è
    DBTools.queryActivities().then((data) => {
      this.recommendedActivities = data.slice(0, 5); // æ¨èå‰5ä¸ªæ´»åŠ¨
    }).catch((err: Error) => {
      console.error('Failed to load activity recommendations:', err.message);
    });

    const userId = AppStorage.get<number>('currentUserId');
    if (!userId) {
      this.loadDefaultRecommendations();
      return;
    }

    try {
      // 1. è·å–ç”¨æˆ·æœ€è¿‘é¢„çº¦
      const reservations = await DBTools.queryReservationsByUserId(userId);
      
      if (reservations.length === 0) {
        this.recommendationTitle = 'çƒ­é—¨æ¨è';
        this.loadDefaultRecommendations();
        return;
      }

      const lastReservation = reservations[0];
      const lastFacilityId = lastReservation.facility_id;

      // 2. è·å–æ‰€æœ‰è®¾æ–½
      const allFacilities = await DBTools.queryFacilities();
      
      // 3. æ‰¾åˆ°æœ€è¿‘é¢„çº¦çš„è®¾æ–½ç±»å‹
      const lastFacility = allFacilities.find(f => f.facility_id === lastFacilityId);
      
      if (!lastFacility) {
        this.loadDefaultRecommendations();
        return;
      }

      const targetType = lastFacility.facility_type;
      this.recommendationTitle = `çŒœä½ å–œæ¬¢ (${targetType})`;

      // 4. ç­›é€‰åŒç±»å‹è®¾æ–½ä¼˜å…ˆæ˜¾ç¤º
      let recs = allFacilities.filter(f => f.facility_type === targetType);
      
      // å¦‚æœåŒç±»å‹ä¸è¶³3ä¸ªï¼Œè¡¥å…¨å…¶ä»–ç±»å‹çš„è®¾æ–½
      if (recs.length < 3) {
        const others = allFacilities.filter(f => f.facility_type !== targetType);
        recs = recs.concat(others);
      }

      this.recommendations = recs;

    } catch (err) {
      console.error('Load recommendations failed', err);
      this.loadDefaultRecommendations();
    }
  }

  loadDefaultRecommendations() {
    this.recommendationTitle = 'ä»Šæ—¥æ¨è';
    DBTools.queryFacilities().then((data) => {
      this.recommendations = data;
    }).catch((err: Error) => {
      console.error('Failed to load default recommendations:', err.message);
    });
  }

  loadUserInfo() {
    const userId = AppStorage.get<number>('currentUserId');
    if (userId) {
      DBTools.queryUserById(userId).then((user) => {
        this.currentUser = user;
      });
    }
  }

  loadFacilities() {
    DBTools.queryFacilities().then((data) => {
      this.facilities = data;
    }).catch((err: Error) => {
      console.error('Failed to load facilities:', err.message);
    });
  }

getFacilityImage(imageName: string | null): Resource {
  if (imageName === 'gym') {
    return $r('app.media.gym'); // ç¡®ä¿ media ç›®å½•ä¸‹æœ‰ gym.png
  }
  if (imageName === 'soccer') {
    return $r('app.media.soccer'); // ç¡®ä¿ media ç›®å½•ä¸‹æœ‰ soccer.png
  }
  if (imageName === 'pool') {
    return $r('app.media.pool'); // ç¡®ä¿ media ç›®å½•ä¸‹æœ‰ pool.png
  }
  return $r('app.media.background'); // é»˜è®¤å›¾ç‰‡
}

  @Builder TabBuilder(title: string, targetIndex: number, selectedImg: Resource, normalImg: Resource) {
    Column() {
      Text(targetIndex === 0 ? 'ğŸ”¥' : (targetIndex === 1 ? 'ğŸŸï¸' : 'ğŸ‘¤'))
        .fontSize(24)
        .margin({ bottom: 4 })
      Text(title)
        .fontSize(10)
        .fontColor(this.currentIndex === targetIndex ? '#1698CE' : '#6B6B6B')
    }
    .width('100%')
    .height(50)
    .justifyContent(FlexAlign.Center)
    .onClick(() => {
      this.currentIndex = targetIndex;
      this.controller.changeIndex(this.currentIndex);
    })
  }

  build() {
    Column() {
      Tabs({ barPosition: BarPosition.End, controller: this.controller }) {
        // 1. æ¨èé¡µé¢
        TabContent() {
          Column() {
            List({ space: 15 }) {
              // æ¨èè®¾æ–½æ ‡é¢˜
              ListItem() {
                Row() {
                  Text('âœ¨')
                    .fontSize(24)
                    .margin({ right: 10 })
                  Text(this.recommendationTitle)
                    .fontSize(24)
                    .fontWeight(FontWeight.Bold)
                }
                .margin({ top: 20, bottom: 5, left: 20 })
              }

              // æ¨èè®¾æ–½åˆ—è¡¨
              ForEach(this.recommendations, (item: Facility) => {
                ListItem() {
                  Column() {
                    Stack({ alignContent: Alignment.TopEnd }) {
                      Image(this.getFacilityImage(item.image)) // ä½¿ç”¨åŠ¨æ€å›¾ç‰‡
                        .width('100%')
                        .height(150)
                        .borderRadius({ topLeft: 10, topRight: 10 })
                        .backgroundColor(Color.Gray)
                        .objectFit(ImageFit.Cover)
                      
                      Text(item.facility_type)
                        .fontSize(12)
                        .fontColor(Color.White)
                        .backgroundColor('#1698CE')
                        .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                        .borderRadius({ topLeft: 0, topRight: 10, bottomLeft: 10, bottomRight: 0 })
                        .margin({ top: 0, right: 0 })
                    }
                    
                    Column() {
                      Row() {
                        Text(item.facility_name)
                          .fontSize(18)
                          .fontWeight(FontWeight.Bold)
                      }
                      .width('100%')
                      .alignItems(VerticalAlign.Center)
                      .margin({ bottom: 8 })

                      Text(item.description)
                        .fontSize(14)
                        .fontColor(Color.Gray)
                        .maxLines(2)
                        .textOverflow({ overflow: TextOverflow.Ellipsis })
                        .width('100%')
                    }
                    .padding(12)
                    .width('100%')
                    .backgroundColor(Color.White)
                    .borderRadius({ bottomLeft: 10, bottomRight: 10 })
                  }
                  .width('90%')
                  .margin({ left: '5%', right: '5%' }) // å±…ä¸­
                  .shadow({ radius: 5, color: '#1F000000', offsetY: 2 })
                  .borderRadius(10)
                  .onClick(() => {
                    router.pushUrl({
                      url: 'pages/FacilityDetail',
                      params: {
                        facility: item
                      }
                    })
                  })
                }
              })

              // æ¨èæ´»åŠ¨æ ‡é¢˜
              if (this.recommendedActivities.length > 0) {
                ListItem() {
                  Row() {
                    Text('ğŸ“…')
                      .fontSize(24)
                      .margin({ right: 10 })
                    Text('çƒ­é—¨æ´»åŠ¨')
                      .fontSize(24)
                      .fontWeight(FontWeight.Bold)
                  }
                  .margin({ top: 20, bottom: 5, left: 20 })
                }

                // æ¨èæ´»åŠ¨åˆ—è¡¨
                ForEach(this.recommendedActivities, (item: Activity) => {
                  ListItem() {
                    Column() {
                      Row() {
                        Text(item.title)
                          .fontSize(18)
                          .fontWeight(FontWeight.Bold)
                        Blank()
                        Text(item.status === 'open' ? 'æŠ¥åä¸­' : item.status)
                          .fontSize(12)
                          .fontColor(Color.White)
                          .backgroundColor(item.status === 'open' ? '#52C41A' : '#999')
                          .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                          .borderRadius(10)
                      }
                      .width('100%')
                      .margin({ bottom: 8 })

                      Row() {
                        Text('ğŸ“')
                          .fontSize(14)
                          .margin({ right: 5 })
                        Text((item.facility_name || 'æœªçŸ¥åœ°ç‚¹'))
                          .fontSize(14)
                          .fontColor(Color.Gray)
                      }
                      .width('100%')
                      .margin({ bottom: 5 })

                      Row() {
                        Text('ğŸ•’')
                          .fontSize(14)
                          .margin({ right: 5 })
                        Text(item.start_time)
                          .fontSize(14)
                          .fontColor(Color.Gray)
                      }
                      .width('100%')
                      .margin({ bottom: 5 })

                      Row() {
                        Text('ğŸ‘¥')
                          .fontSize(14)
                          .margin({ right: 5 })
                        Text(`å·²æŠ¥å: ${item.participant_count || 0}äºº`)
                          .fontSize(14)
                          .fontColor(Color.Gray)
                      }
                      .width('100%')
                      .margin({ bottom: 5 })

                      Text(item.description)
                        .fontSize(14)
                        .fontColor('#666')
                        .maxLines(2)
                        .textOverflow({ overflow: TextOverflow.Ellipsis })
                        .width('100%')
                    }
                    .width('90%')
                    .margin({ left: '5%', right: '5%' })
                    .padding(15)
                    .backgroundColor(Color.White)
                    .borderRadius(10)
                    .shadow({ radius: 5, color: '#1F000000', offsetY: 2 })
                    .onClick(() => {
                      // å°è¯•è·³è½¬åˆ°å¯¹åº”è®¾æ–½è¯¦æƒ…
                      const facility = this.facilities.find(f => f.facility_id === item.facility_id);
                      if (facility) {
                        router.pushUrl({
                          url: 'pages/FacilityDetail',
                          params: {
                            facility: facility
                          }
                        })
                      }
                    })
                  }
                })
              }
              
              // åº•éƒ¨ç•™ç™½
              ListItem() {
                Row().height(20)
              }
            }
            .width('100%')
            .layoutWeight(1)
          }
          .width('100%')
          .height('100%')
          .backgroundColor('#F1F3F5')
        }
        .tabBar(this.TabBuilder('æ¨è', 0, $r('app.media.startIcon'), $r('app.media.startIcon'))) // ä½¿ç”¨é»˜è®¤å›¾æ ‡å ä½

        // 2. è®¾æ–½é¡µé¢
        TabContent() {
          Column() {
            Row() {
              Text('ğŸŸï¸')
                .fontSize(24)
                .margin({ right: 10 })
              Text('è®¾æ–½åˆ—è¡¨')
                .fontSize(24)
                .fontWeight(FontWeight.Bold)
            }
            .width('100%')
            .padding({ left: 20, top: 20, bottom: 10 })

            List({ space: 10 }) {
              ForEach(this.facilities, (item: Facility) => {
                ListItem() {
                  Row() {
                    Image(this.getFacilityImage(item.image)) // ä½¿ç”¨åŠ¨æ€å›¾ç‰‡
                      .width(60)
                      .height(60)
                      .borderRadius(8)
                      .backgroundColor('#EEE')
                      .margin({ right: 15 })

                    Column() {
                      Text(item.facility_name)
                        .fontSize(18)
                        .fontWeight(FontWeight.Bold)
                      
                      Row() {
                        Text('ğŸ“')
                          .fontSize(12)
                          .margin({ right: 4 })
                        Text(item.location)
                          .fontSize(14)
                          .fontColor(Color.Gray)
                      }
                      .margin({ top: 5 })
                    }
                    .alignItems(HorizontalAlign.Start)
                    .layoutWeight(1)

                    Text(item.facility_type)
                      .fontSize(12)
                      .fontColor('#1698CE')
                      .padding({ left: 10, right: 10, top: 4, bottom: 4 })
                      .backgroundColor('#E6F7FF')
                      .borderRadius(15)
                  }
                  .width('90%')
                  .padding(15)
                  .backgroundColor(Color.White)
                  .borderRadius(10)
                  .shadow({ radius: 5, color: '#1F000000', offsetX: 2, offsetY: 2 })
                  .onClick(() => {
                    router.pushUrl({
                      url: 'pages/FacilityDetail',
                      params: {
                        facility: item
                      }
                    })
                  })
                }
                .width('100%')
              })
            }
            .width('100%')
            .layoutWeight(1)
          }
          .width('100%')
          .height('100%')
          .backgroundColor('#F1F3F5')
        }
        .tabBar(this.TabBuilder('è®¾æ–½', 1, $r('app.media.startIcon'), $r('app.media.startIcon')))

        // 3. æˆ‘çš„é¡µé¢
        TabContent() {
          Column() {
            Row() {
              Text('ğŸ‘¤') // å¤´åƒå ä½
                .fontSize(40)
                .width(60)
                .height(60)
                .textAlign(TextAlign.Center)
                .backgroundColor('#EEE')
                .borderRadius(30)
                .margin({ right: 15 })
              Column() {
                Text(this.currentUser ? (this.currentUser.full_name || this.currentUser.username) : 'æœªç™»å½•')
                  .fontSize(20)
                  .fontWeight(FontWeight.Bold)
                Text(this.currentUser ? `ID: ${this.currentUser.user_id}` : '')
                  .fontSize(14)
                  .fontColor(Color.Gray)
                  .margin({ top: 5 })
              }
              .alignItems(HorizontalAlign.Start)
            }
            .width('100%')
            .padding(20)
            .backgroundColor(Color.White)
            .margin({ bottom: 10 })
            .onClick(() => {
              if (this.currentUser) {
                router.pushUrl({ url: 'pages/UserInfoEdit' });
              }
            })

            List() {
              ListItem() {
                Row() {
                  Text('ğŸ“…')
                    .fontSize(20)
                    .margin({ right: 10 })
                  Text('æˆ‘çš„é¢„çº¦')
                    .fontSize(16)
                  Blank()
                  Text('>')
                    .fontColor(Color.Gray)
                }
                .width('100%')
                .padding(15)
                .backgroundColor(Color.White)
                .onClick(() => {
                  router.pushUrl({ url: 'pages/MyReservations' });
                })
              }

              ListItem() {
                Row() {
                  Text('ğŸƒ')
                    .fontSize(20)
                    .margin({ right: 10 })
                  Text('æˆ‘çš„æ´»åŠ¨')
                    .fontSize(16)
                  Blank()
                  Text('>')
                    .fontColor(Color.Gray)
                }
                .width('100%')
                .padding(15)
                .backgroundColor(Color.White)
                .margin({ top: 1 })
                .onClick(() => {
                  router.pushUrl({ url: 'pages/MyActivities' });
                })
              }
              
              ListItem() {
                Row() {
                  Text('â­')
                    .fontSize(20)
                    .margin({ right: 10 })
                  Text('è¯„ä»·è®°å½•')
                    .fontSize(16)
                  Blank()
                  Text('>')
                    .fontColor(Color.Gray)
                }
                .width('100%')
                .padding(15)
                .backgroundColor(Color.White)
                .margin({ top: 1 })
                .onClick(() => {
                  router.pushUrl({ url: 'pages/MyRatings' });
                })
              }

              ListItem() {
                Row() {
                  Text('ğŸšª')
                    .fontSize(20)
                    .margin({ right: 10 })
                  Text('é€€å‡ºç™»å½•')
                    .fontSize(16)
                    .fontColor(Color.Red)
                }
                .width('100%')
                .padding(15)
                .backgroundColor(Color.White)
                .justifyContent(FlexAlign.Center)
                .margin({ top: 20 })
                .onClick(() => {
                  router.back();
                })
              }
            }
            .width('100%')
          }
          .width('100%')
          .height('100%')
          .backgroundColor('#F1F3F5')
        }
        .tabBar(this.TabBuilder('æˆ‘çš„', 2, $r('app.media.startIcon'), $r('app.media.startIcon')))
      }
      .scrollable(false)
      .onChange((index: number) => {
        this.currentIndex = index;
      })
    }
    .width('100%')
    .height('100%')
  }
}
