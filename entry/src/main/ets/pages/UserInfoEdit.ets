import { router } from '@kit.ArkUI';
import promptAction from '@ohos.promptAction';
import relationalStore from '@ohos.data.relationalStore';
import DBTools from '../utils/DBTools';
import User from '../model/User';

@Entry
@Component
struct UserInfoEdit {
  @State user: User | null = null;
  @State username: string = '';
  @State fullName: string = '';
  @State phone: string = '';
  @State email: string = '';

  aboutToAppear() {
    this.loadUserInfo();
  }

  loadUserInfo() {
    const userId = AppStorage.get<number>('currentUserId');
    if (userId) {
      DBTools.queryUserById(userId).then((user) => {
        if (user) {
          this.user = user;
          this.username = user.username || '';
          this.fullName = user.full_name || '';
          this.phone = user.phone || '';
          this.email = user.email || '';
        }
      });
    }
  }

  saveUserInfo() {
    if (!this.user || !this.user.user_id) return;

    const updateData: relationalStore.ValuesBucket = {
      // 'username': this.username, // ç”¨æˆ·åä¸å¯ä¿®æ”¹
      'full_name': this.fullName,
      'phone': this.phone,
      'email': this.email
    };

    DBTools.updateById(this.user.user_id, updateData).then((rows) => {
      if (rows > 0) {
        promptAction.showToast({ message: 'ä¿å­˜æˆåŠŸ' });
        // ç¨å¾®å»¶è¿ŸåŽè¿”å›žï¼Œè®©ç”¨æˆ·çœ‹åˆ°æç¤º
        setTimeout(() => {
          router.back();
        }, 500);
      } else {
        promptAction.showToast({ message: 'ä¿å­˜å¤±è´¥æˆ–æœªåšä¿®æ”¹' });
      }
    }).catch((err: Error) => {
      promptAction.showToast({ message: 'ä¿å­˜å‡ºé”™: ' + err.message });
    });
  }

  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text('ðŸ”™')
          .fontSize(20)
          .margin({ right: 5 })
          .onClick(() => {
            router.back();
          })
        Text('ç¼–è¾‘ä¸ªäººä¿¡æ¯')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .margin({ left: 10 })
      }
      .width('100%')
      .padding(15)
      .backgroundColor(Color.White)
      .shadow({ radius: 2, color: '#1F000000', offsetY: 1 })

      if (this.user) {
        Column() {
          // è¡¨å•åŒºåŸŸ
          Column({ space: 20 }) {
            
            // ç”¨æˆ·å
            Column() {
              Text('ðŸ‘¤ ç”¨æˆ·å')
                .fontSize(14)
                .fontColor(Color.Gray)
                .margin({ bottom: 8 })
              TextInput({ text: this.username, placeholder: 'è¯·è¾“å…¥ç”¨æˆ·å' })
                .height(45)
                .enabled(false) // è®¾ç½®ä¸ºä¸å¯ç¼–è¾‘
                .backgroundColor('#F5F5F5') // è®¾ç½®èƒŒæ™¯è‰²è¡¨ç¤ºåªè¯»
                .borderRadius(10)
            }
            .alignItems(HorizontalAlign.Start)
            .width('100%')

            // æ˜µç§°
            Column() {
              Text('ðŸ·ï¸ æ˜µç§°')
                .fontSize(14)
                .fontColor(Color.Gray)
                .margin({ bottom: 8 })
              TextInput({ text: this.fullName, placeholder: 'è¯·è¾“å…¥æ˜µç§°' })
                .height(45)
                .borderRadius(10)
                .backgroundColor(Color.White)
                .border({ width: 1, color: '#EEE' })
                .onChange((value) => {
                  this.fullName = value;
                })
            }
            .alignItems(HorizontalAlign.Start)
            .width('100%')

            // ç”µè¯å·ç 
            Column() {
              Text('ðŸ“± ç”µè¯å·ç ')
                .fontSize(14)
                .fontColor(Color.Gray)
                .margin({ bottom: 8 })
              TextInput({ text: this.phone, placeholder: 'è¯·è¾“å…¥ç”µè¯å·ç ' })
                .height(45)
                .type(InputType.PhoneNumber)
                .borderRadius(10)
                .backgroundColor(Color.White)
                .border({ width: 1, color: '#EEE' })
                .onChange((value) => {
                  this.phone = value;
                })
            }
            .alignItems(HorizontalAlign.Start)
            .width('100%')

            // é‚®ç®±
            Column() {
              Text('ðŸ“§ ç”µå­é‚®ç®±')
                .fontSize(14)
                .fontColor(Color.Gray)
                .margin({ bottom: 8 })
              TextInput({ text: this.email, placeholder: 'è¯·è¾“å…¥ç”µå­é‚®ç®±' })
                .height(45)
                .type(InputType.Email)
                .borderRadius(10)
                .backgroundColor(Color.White)
                .border({ width: 1, color: '#EEE' })
                .onChange((value) => {
                  this.email = value;
                })
            }
            .alignItems(HorizontalAlign.Start)
            .width('100%')

          }
          .padding(20)
          .backgroundColor(Color.White)
          .borderRadius(10)
          .shadow({ radius: 2, color: '#1F000000', offsetY: 1 })
          .margin({ top: 20 })

          // ä¿å­˜æŒ‰é’®
          Button('ðŸ’¾ ä¿å­˜ä¿®æ”¹')
            .width('90%')
            .height(50)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .backgroundColor('#1698CE')
            .shadow({ radius: 5, color: '#4F1698CE', offsetY: 3 })
            .margin({ top: 40 })
            .onClick(() => {
              this.saveUserInfo();
            })

        }
        .width('100%')
        .padding({ left: 15, right: 15 })
      } else {
        LoadingProgress().width(50).height(50).margin({ top: 50 })
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F7FA')
  }
}
